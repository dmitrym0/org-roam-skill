#!/bin/bash
# Auto-loading wrapper for org-roam-skill emacsclient calls
#
# Usage: org-roam-eval "(org-roam-skill-create-note \"Title\")"
#
# This script ensures org-roam-skill is loaded before executing the elisp expression.
# On first call, it loads the package into the running Emacs daemon.
# Subsequent calls use the already-loaded package (fast).

set -euo pipefail

# Get the directory where this script lives (skill directory)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"

# Check if org-roam-skill is loaded, load if not
emacsclient --eval "(featurep 'org-roam-skill)" 2>/dev/null | grep -q "nil" && {
    # Not loaded, load it now
    emacsclient --eval "(progn
        (add-to-list 'load-path \"$SKILL_DIR/elisp\")
        (require 'org-roam-skill))" >/dev/null || {
        echo "Error: Failed to load org-roam-skill package" >&2
        echo "Ensure Emacs daemon is running with org-roam installed" >&2
        exit 1
    }
}

# Execute the provided elisp expression
emacsclient --eval "$1"
